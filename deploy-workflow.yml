name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
        run: |
          # SSHã‚­ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # known_hostsã«è¿½åŠ ï¼ˆãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã®æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

          # VPSã«æ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" << 'ENDSSH'
            set -e

            echo "ğŸ“¦ Deploying n8n to VPS..."

            # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
            cd ${VPS_DEPLOY_PATH}

            # Gitãƒªãƒã‚¸ãƒˆãƒªã‚’æ›´æ–°
            echo "ğŸ”„ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main

            # .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            if [ ! -f .env ]; then
              echo "âš ï¸  Warning: .env file not found. Please create it from .env.example"
              echo "   Deployment will continue but services may not start correctly."
            fi

            # Docker Composeã§æ›´æ–°ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«
            echo "ğŸ³ Pulling Docker images..."
            docker compose pull

            # ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ï¼ˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚’æœ€å°åŒ–ï¼‰
            echo "ğŸ”„ Restarting services..."
            docker compose up -d --remove-orphans

            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§60ç§’å¾…æ©Ÿï¼‰
            echo "ğŸ¥ Checking service health..."
            for i in {1..12}; do
              if docker compose ps | grep -q "healthy"; then
                echo "âœ… Services are healthy!"
                break
              fi
              echo "   Waiting for services to become healthy... ($i/12)"
              sleep 5
            done

            # æœ€çµ‚çŠ¶æ…‹ã‚’è¡¨ç¤º
            echo "ğŸ“Š Current service status:"
            docker compose ps

            echo "âœ… Deployment completed!"
          ENDSSH

          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f ~/.ssh/deploy_key

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
